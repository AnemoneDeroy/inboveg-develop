---
title: "Tutorial on how to retrieve data from the INBOVEG database"
author: "Hans Van Calster & Els De Bie"
date: "1 maart 2019 (updated `r Sys.Date()`)"
output: html_document
---


```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = TRUE)
```

# Packages and connection

The following packages are needed to run this code:

* knitr
* tidyverse
* DBI
* odbc
* glue

Be sure you have reading-rights for CYDONIA
otherwise place an ICTcall (ict.helpdesk@inbo.be)


```{r}
library(knitr)
library(tidyverse)
library(DBI)
library(glue)
```

The following R-code can be used to establish a connection to INBOVEG by means of a dsn connection. This assumes that you have set up this dsn in your Windows ODBC manager.

```{r}
con <- dbConnect(odbc::odbc(), dsn = "Cydonia-prd") 
```

Alternatively, the following R-code can be used, that only requires that you are working from within the INBO network.

<!-- TO DO change the connection string -->

```{r}
con <- dbConnect(odbc::odbc(), .connection_string = "Driver=SQL Server;Server=inbo-sql07-prd.inbo.be,1433;Database=D0021_00_userFlora;Trusted_Connection=Yes;")
```



# Retrieving data

## *iv_Survey*:

-gives the list of all surveys in InboVeg

HIER functie maken waar je bv een deel van een survey naam kan ingeven als je gehele naam niet meer kent?
 contains $MILKLIM$



## *iv_headerinfo*: 

- contains metadata for a vegetation-relevé (one row per vegetation-relevé identified by 'RecordingGivid')
- specify two parameters for the function:
    - RecType = c('Classic', 'Classic-emmer', 'Classic-ketting', 'BioHab', 'ABS')
    - SurveyName = to get the list, run the code under "## iv_survey
    
    
```{r, include=FALSE}

header_info <- function(Name, RecType) {
  dbGetQuery(con,
    "SELECT 
      ivR.[RecordingGivid]
      , ivS.Name
      , ivR.UserReference
      , ivR.LocationCode
      , ivR.Latitude
      , ivR.Longitude
      , ivR.Area
      , ivR.Length
      , ivR.Width
      , ivR.SurveyId
      , coalesce(area, convert( nvarchar(20),ivR.Length * ivR.Width)) as B
      FROM [dbo].[ivRecording] ivR
      INNER JOIN [dbo].[ivSurvey] ivS on ivS.Id = ivR.SurveyId
      where ivR.NeedsWork = 0
      AND Name = Name,
      RecType = RecType
      
      
      ;")
}

```

Give up survey-name and Recordtype in this function

Headerinfo <- header_info(Name, RecType)

